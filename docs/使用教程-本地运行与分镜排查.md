# Huobao Drama 使用教程（本地运行 + 分镜到专业编辑器）

本文按当前代码实现整理，重点补充“分镜成功后进入专业编辑器”的完整使用流程。

## 1. 端口与服务

- 前端开发服务：`http://127.0.0.1:3012`
- 后端服务：`http://127.0.0.1:5678`
- 健康检查：`http://127.0.0.1:5678/health`

代码依据：
- `api/routes/routes.go`
- `web/src/api/generation.ts`

## 2. 本地启动（Windows PowerShell）

在项目根目录 `d:\huobao\huobao-drama`：

```powershell
# 终端1：后端
go run main.go
```

```powershell
# 终端2：前端
cd web
npm install
npm run dev
```

## 3. 从章节到分镜（进入专业编辑器前）

1. 在剧集页填写章节内容并保存。  
2. 在章节工作流中完成角色/场景提取、图片生成。  
3. 点击“AI自动拆分”发起分镜任务。  
4. 分镜任务成功后，页面会跳转到“专业编辑器”。

代码依据：
- `web/src/views/drama/EpisodeWorkflow.vue`
- `web/src/views/drama/ProfessionalEditor.vue`

## 4. 专业编辑器详细操作教程（重点）

专业编辑器分为三块：
- 左侧：镜头列表（脚本结构）
- 中间：时间线编辑区（VideoTimelineEditor）
- 右侧：标签页（镜头属性 / 镜头图片 / 视频生成 / 音效与配乐 / 视频合成）

代码依据：
- `web/src/views/drama/ProfessionalEditor.vue`

### 4.1 左侧镜头列表（脚本结构）

可做的操作：
- 点击镜头条目：切换当前镜头
- 点击“添加”：新增镜头
- 点击红色删除图标：删除镜头

建议：
- 先把镜头顺序和镜头时长（秒）确认好，再进行视频生成，避免后续返工。

对应代码：
- `handleAddStoryboard`
- `handleDeleteStoryboard`
- `selectStoryboard`

### 4.2 右侧 `镜头属性` 标签

这是“修分镜文本”的核心区域，建议按顺序编辑：

1. 场景（Scene）  
- 点“选择场景”，给当前镜头绑定背景场景  
- 可点击场景预览图放大查看

2. 登场角色（Cast）  
- 点“添加角色”将角色加入镜头  
- 点角色右上角移除按钮可删除角色

3. 道具（Props）  
- 点“添加道具”绑定道具  
- 同样支持移除

4. 视觉参数  
- 景别（shot_type）  
- 运镜（movement）  
- 镜头角度（angle）  

5. 文本字段  
- 动作描述（Action）  
- 动作结果（Result）  
- 对白（Dialogue）  
- 镜头描述（Description）  
- 音效（sound_effect）  
- 配乐提示（bgm_prompt）  
- 氛围（atmosphere）

保存机制：
- 下拉字段切换会立即保存
- 文本框失焦（blur）后保存

对应代码：
- `saveStoryboardField`
- `selectScene`
- `toggleCharacterInShot`
- `togglePropInShot`

### 4.3 右侧 `镜头图片` 标签

用途：为当前镜头生成可用于视频生成的参考图。

操作顺序：
1. 选择帧类型：首帧 / 尾帧 / 动作序列 / 关键帧  
2. 点击“提取提示词”（自动生成该帧类型 prompt）  
3. 可手工调整 prompt  
4. 点击“生成图片”  
5. 在结果区检查图片，可删除不满意结果  
6. 也可“上传图片”作为参考图

动作序列说明：
- 当帧类型为 `action` 时，可进入网格图入口做动作序列图（用于连续动作表现）。

对应代码：
- `extractFramePrompt`
- `generateFrameImage`
- `uploadImage`
- `handleDeleteImage`

### 4.4 右侧 `视频生成` 标签

用途：基于当前镜头 prompt + 参考图生成单镜头视频。

推荐流程：
1. 确认视频模型  
- 在“模型”下拉里选已配置且可用模型

2. 选择参考图模式  
- 按模型能力选择（如首尾帧、多图等模式）

3. 设置时长  
- 滑条范围 4-10 秒（会参考镜头时长）

4. 选择参考图  
- 可在首帧/尾帧/动作序列/关键帧中切换选择  
- 支持选中上一镜头尾帧，提升镜头衔接

5. 点击“生成视频”  
- 生成后在下方列表查看状态  
- 成功后可“加入素材库”

6. 清理与替换  
- 列表支持删除不需要的视频  
- 若同镜头已有素材，加入素材库时会执行替换

对应代码：
- `generateVideo`
- `addVideoToAssets`
- `handleDeleteVideo`
- `loadVideoModels`

### 4.5 中间时间线（素材编排与合成）

当镜头视频加入素材库后，在中间时间线可进行编排：
- 拖拽素材到时间线轨道
- 调整镜头顺序和衔接
- 触发视频合成任务

合成结果在右侧 `视频合成` 标签中查看：
- pending / processing / completed / failed
- 完成后可下载或预览

对应代码：
- `VideoTimelineEditor` 组件事件：
  - `@merge-completed`
  - `@asset-deleted`
- 合成记录相关：
  - `loadVideoMerges`
  - `deleteMerge`
  - `downloadVideo`
  - `previewMergedVideo`

## 5. AI 配置（火山引擎文本模型）

在 AI 配置里新增文本服务：
- Provider：`volcengine`
- Model：`doubao-seed-1-8-251228`
- Base URL：`https://ark.cn-beijing.volces.com/api/v3`
- API Key：你的火山方舟 Key

补充：
- `doubao-seed-1.8` 在后端会归一化为 `doubao-seed-1-8-251228`。

代码依据：
- `web/src/components/common/AIConfigDialog.vue`
- `web/src/views/settings/AIConfig.vue`
- `application/services/ai_service.go`（`normalizeModelForProvider`）

## 6. API 测活

接口：
- `POST /api/v1/ai-configs/alive`

PowerShell 示例：

```powershell
curl.exe -X POST "http://127.0.0.1:5678/api/v1/ai-configs/alive" ^
  -H "Content-Type: application/json" ^
  -d "{\"base_url\":\"https://ark.cn-beijing.volces.com/api/v3\",\"api_key\":\"你的Key\",\"provider\":\"volcengine\",\"model\":\"doubao-seed-1-8-251228\",\"endpoint\":\"/chat/completions\",\"prompt\":\"Hello\"}"
```

成功返回：
- `alive: true`
- `reply`
- `latency_ms`

代码依据：
- `api/handlers/ai_config.go`
- `application/services/ai_service.go`
- `web/src/api/ai.ts`

## 7. 分镜失败排查

### 7.1 前端先看任务

- 创建任务：`POST /api/v1/episodes/{episode_id}/storyboards`
- 查询任务：`GET /api/v1/tasks/{task_id}`

前端现在会优先显示失败原因：
- `task.message`
- `task.error`
- `task.result`

代码依据：
- `web/src/views/drama/EpisodeWorkflow.vue`

### 7.2 后端日志

```powershell
Get-Content .\run-backend.log -Wait
```

重点看：
- `Generating storyboard asynchronously`
- 模型请求日志（如 `OpenAI: Sending request to ...`）
- 超时或权限错误

### 7.3 常见原因

- 文本模型配置未激活
- API Key 无权限/额度不足
- Base URL 与 endpoint 组合错误
- 模型名称拼写错误
- 章节脚本为空

## 8. 常用运维命令

查看 3012/5678 端口：

```powershell
Get-NetTCPConnection -State Listen | Where-Object { $_.LocalPort -in 3012,5678 } | Format-Table -AutoSize
```

结束进程：

```powershell
Stop-Process -Id <PID> -Force
```

