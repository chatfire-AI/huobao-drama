# 小说上传解析功能技术设计

## 1. 功能概述

用户上传小说文件（txt/word/pdf），系统自动解析小说章节结构，将章节内容保存为项目章节数据。

## 2. 数据模型

### 2.1 新增解析任务表 (NovelParseTask)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uint | 主键 |
| drama_id | uint | 关联的项目ID（解析完成后关联） |
| file_name | varchar(255) | 原始文件名 |
| file_path | varchar(500) | 文件存储路径 |
| file_size | int64 | 文件大小(字节) |
| status | varchar(20) | 状态: pending/running/completed/failed/cancelled |
| progress | int | 进度百分比(0-100) |
| error_message | text | 错误信息 |
| total_chapters | int | 总章节数 |
| created_chapters | int | 已解析章节数 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

### 2.2 Episode模型（已有）

保持现有结构不变：
- episode_number: 章节序号
- title: 章节标题
- script_content: 章节内容

## 3. API设计

### 3.1 创建解析任务

```
POST /api/v1/novel-parse/tasks

Request:
Content-Type: multipart/form-data
file: 文件二进制
title: 项目标题（可选，默认使用文件名）

Response:
{
  "code": 0,
  "data": {
    "task_id": 1,
    "status": "running",
    "progress": 0
  }
}
```

### 3.2 查询任务状态

```
GET /api/v1/novel-parse/tasks/:task_id

Response:
{
  "code": 0,
  "data": {
    "task_id": 1,
    "status": "running",
    "progress": 50,
    "total_chapters": 0,
    "created_chapters": 0,
    "chapters": []  // 解析中的章节列表（可选）
  }
}
```

### 3.3 取消解析任务

```
POST /api/v1/novel-parse/tasks/:task_id/cancel

Response:
{
  "code": 0,
  "message": "任务已取消"
}
```

## 4. 核心流程

### 4.1 解析流程图

```
┌─────────────────┐
│     用户上传文件 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  保存文件到本地   │
│  创建解析任务     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  读取文件内容    │
│  调用AI解析      │
└────────┬────────┘
         │
         ▼
    ┌────┴────┐
    │ 结果检查 │
    └────┬────┘
         │
    ┌────┴────┐
    │hasMore? │
    └────┬────┘
      是 │    │ 否
         ▼    ▼
┌─────────────────┐
│  继续同一会话    │ ──→ 合并章节列表
│  请求剩余章节    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  创建项目(Drama) │
│  保存章节列表    │
│  更新任务状态    │
└─────────────────┘
```

### 4.2 分段解析逻辑

1. **第一次请求**：发送全文内容 + 系统提示词
2. **检查返回**：判断 `hasMore` 是否为 true
3. **继续请求**：如果需要继续，发送 "请继续" 提示，AI继续输出后续章节
4. **循环直到完成**：直到 `hasMore` 为 false 或达到最大重试次数
5. **合并结果**：将所有章节合并为一个列表

## 5. AI提示词设计

### 5.1 系统提示词

```
# 角色设定
你是一位专业的短剧编剧，擅长将小说文字转化为高张力的视觉化剧本。你的任务是直接进入【章节提炼模式】，将我上传的小说内容拆解并重构。

# 核心指令
1. **自动分集：** 请根据小说情节的自然转折、冲突爆发点或信息量的密集程度，自动决定提炼出的剧本集数。
2. **去水留精：** 删掉所有环境描写、心理独白和非必要的过渡情节。只保留能推动剧情的**动作**和**台词**。
3. **节奏重塑：** 每一集必须符合短剧"黄金30秒一个反转，结尾一个大钩子"的规律。

# 章节提炼格式（请按此结构逐集输出）
**第 [X] 集：[集名]**
* **【核心冲突】：** [本集要解决的矛盾或爆发的爆点]
* **【视觉画面】：** [动作指令1]：(例如：男主摔碎杯子，冷漠地擦去手上的血)
              [动作指令2]：(例如：女主在雨中转身，眼神从绝望变为决绝)
* **【对白提炼】：** 角色A：(台词，要求：短促、有力、具有攻击性)
              角色B：(台词，要求：反转或情绪爆发)
* **【断点钩子】：** [本集结束在哪个最让人心痒的瞬间？请详细描述最后一秒的画面或台词]

# 提炼要求
* **人设还原：** 必须精准捕捉小说中主角的性格特征。
* **信息密度：** 确保每一集都有实质性的剧情进展，拒绝平铺直叙。
* **分集逻辑：** 不要按照字数平均切分，要按照**"爽点"**和**"悬念"**切分。

# 输出格式（必须严格JSON，不要包含其他内容）
{
  "episodes": [
    {
      "number": 1,
      "title": "第1集 集名",
      "conflict": "核心冲突描述",
      "visuals": ["动作指令1", "动作指令2"],
      "dialogues": [{"role": "角色A", "line": "台词内容"}],
      "hook": "断点钩子描述",
      "fullScript": "【核心冲突】：...\n【视觉画面】：...\n【对白提炼】：...\n【断点钩子】：..."
    }
  ],
  "hasMore": true,
  "processedCount": 10
}

# 重要说明
1. **fullScript字段**：必须包含完整、自然语言的剧本提炼内容（包含核心冲突、视觉画面、对白提炼、断点钩子），这是后续要存入数据库的内容
2. **hasMore标记**：如果本轮输出未包含全部集数，设置hasMore为true；已全部输出则设置为false
3. **processedCount**：本轮已处理的集数，用于断点续传
4. **分段输出**：如果小说内容较长，单次输出限制为20集以内，超出则设置hasMore为true，等待继续请求
5. **继续请求**：收到"请继续"指令时，从上一集的下一集开始继续输出，保持JSON格式不变
```

### 5.2 继续提示词

```
请继续输出剩余的章节内容。格式同上，继续从上一集的下一集开始输出。
```

## 6. 文件格式支持

### 6.1 支持格式

| 格式 | 文件扩展名 | 解析方式 |
|------|-----------|----------|
| 纯文本 | .txt | 直接读取文本内容 |
| Word文档 | .docx | 使用unioffice解析 |
| PDF | .pdf | 使用pdf解析库 |

### 6.2 文件大小限制

- 最大文件大小：10MB
- 超出返回错误： "文件大小不能超过10MB"

## 7. 前端交互

### 7.1 入口位置

| 入口位置 | 描述 |
|----------|------|
| **项目概览** | "从小说导入"卡片入口 |
| **章节管理** | 与"新增章节"按钮并列，显示"从小说导入"按钮 |

### 7.2 项目概览Tab

```
┌─────────────────────────────────────────────────────────────┐
│  [项目概览]  [章节管理]  [角色设计]  [分镜创作]  [视频合成]│
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  项目名称: xxx                                             │
│  状态: 进行中                                               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📚 从小说导入                                        │   │
│  │  上传小说文件，自动解析为项目章节                       │   │
│  │                                                       │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  拖拽文件到此处，或点击选择                       │  │   │
│  │  │  支持 txt, docx, pdf                           │  │   │
│  │  │               [选择文件]                        │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  │                                                       │   │
│  │  已选择: xxx.txt (1.2MB)          [开始解析]        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 章节管理Tab

```
┌─────────────────────────────────────────────────────────────┐
│  [项目概览]  [章节管理]  [角色设计]  [分镜创作]  [视频合成]│
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [+ 新增章节]  [📚 从小说导入]                              │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  拖拽文件到此处，或点击选择                           │   │
│  │  支持 txt, docx, pdf                               │   │
│  │               [选择文件]                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  已选择: xxx.txt (1.2MB)            [开始解析]              │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  章节列表（空）                                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.4 解析中页面

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  正在解析小说...                         [取消解析]        │
│                                                             │
│  ████████████░░░░░░░░  60%                                │
│                                                             │
│  步骤1/4: 上传文件完成                                      │
│  步骤2/4: AI分析中...                                       │
│  步骤3/4: 等待中...                                         │
│  步骤4/4: 等待中...                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.5 解析完成页面

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  ✅ 解析完成！共发现 25 集                                  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 第1集 豪门弃少的逆袭之路                   [预览]     │   │
│  │ 第2集 神秘戒指的真相                     [预览]     │   │
│  │ 第3集 退婚的耻辱                       [预览]     │   │
│  │ ...                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│         [查看项目详情]                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.6 交互流程图

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  上传文件     │────▶│  文件上传成功 │────▶│  点击开始解析 │
└──────────────┘     └──────────────┘     └──────────────┘
                                                  │
                                                  ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  解析失败     │◀────│  解析中...   │────▶│  解析完成    │
└──────────────┘     └──────────────┘     └──────────────┘
       │                    │                      │
       │              [取消解析]                    │
       │                    │                      │
       └────────────────────┘                      ▼
                                                 查看章节详情
```

### 7.7 状态说明

| 状态 | 说明 |
|------|------|
| idle | 初始状态，等待上传文件 |
| fileUploaded | 文件已上传，等待点击开始解析 |
| parsing | 解析中，展示进度 |
| completed | 解析完成，展示章节列表 |
| failed | 解析失败，展示错误信息 |
| cancelled | 用户取消 |

## 8. 错误处理

| 错误场景 | 处理方式 |
|----------|----------|
| 文件格式不支持 | 返回错误提示：仅支持txt/docx/pdf |
| 文件大小超过10MB | 返回错误提示：文件大小不能超过10MB |
| 文件读取失败 | 标记任务failed，提示"文件解析失败" |
| AI调用失败 | 标记任务failed，记录错误信息 |
| 用户取消 | 标记任务cancelled，停止后续处理 |

## 9. 技术实现

### 9.1 后端模块

| 模块 | 路径 | 说明 |
|------|------|------|
| Handler | api/handlers/novel_parse.go | 解析任务HTTP处理 |
| Service | application/services/novel_parse_service.go | 解析业务逻辑 |
| Model | domain/models/novel_parse_task.go | 任务模型 |
| FileParser | infrastructure/parser/ | 文件解析器 |

### 9.2 文件解析库

```
infrastructure/parser/
├── txt_parser.go      # 纯文本解析
├── docx_parser.go     # Word解析
├── pdf_parser.go      # PDF解析
└── parser.go          # 统一接口
```

## 10. 配置项

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| novel.max_file_size | 最大文件大小 | 10MB |
| novel.ai_max_retries | AI调用最大重试次数 | 3 |
| novel.chunk_size | 单次解析最大章节数 | 20 |

## 11. 功能入口

### 11.1 入口位置

功能入口位于**项目详情页**的两个Tab下：

```
┌─────────────────────────────────────────────────────────────┐
│  项目详情页                                                    │
├─────────────────────────────────────────────────────────────┤
│  [项目概览]  [章节管理]  [角色设计]  [分镜创作]  [视频合成]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  项目概览Tab:                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  项目名称: xxx                                        │   │
│  │  状态: 进行中                                         │   │
│  │  ...                                                 │   │
│  │                                                      │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  📚 从小说导入                                 │    │   │
│  │  │  上传小说文件，自动解析为项目章节                │    │   │
│  │  │        [选择文件]                              │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  章节管理Tab:                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [+ 新增章节]  [📚 从小说导入]                        │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  第1集 章节标题                           [编辑][删除] │
│  │  第2集 章节标题                           [编辑][删除] │
│  │  ...                                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 11.2 入口说明

| 入口位置 | 描述 |
|----------|------|
| **项目概览** | 在项目基本信息区域下方，展示"从小说导入"卡片入口 |
| **章节管理** | 在章节列表上方，与"新增章节"按钮并列 |

### 11.3 交互流程

1. **从项目概览进入**：
   - 点击"从小说导入"卡片
   - 弹出上传对话框
   - 上传并解析后，自动创建章节

2. **从章节管理进入**：
   - 点击"从小说导入"按钮
   - 弹出上传对话框
   - 上传并解析后，追加到章节列表

---

## 12. 待确认

1. [x] 文件解析库的选择（docx/pdf解析）
2. [x] AI模型选择和配置
3. [x] 章节内容过长时的截断策略
4. [x] 功能入口位置（项目概览 + 章节管理Tab）
